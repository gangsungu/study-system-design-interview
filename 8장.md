## URL 단축기 설계

### 문제 이해 및 설계 범위 확장
시스템 설계 문제는 답이 정해진 문제가 아니다  
따라서 면접장에서 질문을 통해 모호함을 좁히고 요구사항을 알아내야 한다  

+ 시스템의 기본적 기능
    - URL 단축
    - URL 리디렉션 : 축약된 URL로 HTTP 요청이 오면 원래 URL으로 안내
    - 높은 가용성과 규모 확장성, 장애 감내
+ 개략적 추정
    - 쓰기 연산 : 매일 1억개의 단축 URL 생성
    - 초당 쓰기 연산 : 1억/24/3600 = 1160
    - 읽기 연산 : 읽기 연산과 쓰기 연산 비율은 10:1이라 가정, 읽기 연산은 초당 11600회 발생
    - URL 단축 서비스를 10년간 운영한다고 가정 : 1억 * 365 * 10년
    - 축약 전 URL의 평균 길이는 100자 이내
    - 따라서 10년동안 필요한 저장 용량은 3650억 * 100바이트 = 36.5TB

### 개략적 설계안 제시 및 동의 구하기
API 엔드포인트, URL 리디렉션, URL 단축 플로우에 대해서 살펴보자  

**API 엔드포인트**
+ URL 단축 엔드포인트 : 새 단축 URL을 생성하고자 하는 클라이언트는 엔드포인트에 URL을 인자로 담아 POST 요청을 보내야 함
+ URL 리디렉션 엔드포인트 : 단축 URL을 받으면 원래 URL로 리디렉션하는 용도의 엔드포인트

**URL 리디렉션**
단축 URL을 받은 서버는 받은 URL을 원래 URL으로 바꾸어 301 응답의 Location 헤더에 넣어 반환한다  
서버 부하를 줄이고 싶으면 301 Moved Permanently를 사용하는 것이 좋은데, 첫번째 요청만 단축 URL로 전달될 것이기 때문

+ 301 Moved Permanently (영구 이동)
    - `이 페이지는 완전히 다른 곳으로 이사갔어요. 앞으로 새 주소만 기억하세요`
    - 영구적인 이동을 의미
    - 브라우저와 검색 엔진은 이 정보를 캐시
    - 다음 요청부터는 원래 URL을 요청하지 않고 바로 새 URL으로 이동
    - 사용
        + 도메인을 완전히 변경했을 때
        + URL 구조를 영구적으로 변경했을 때
        + HTTPS로 완전히 이전했을 때
+ 302 Found (임시 이동)
    - `지금은 잠깐 다른 곳에 있지만 나중에 다시 돌아올 수 있어요~`
    - 일시적인 이동을 의미
    - 브라우저는 원래 URL을 계속 기억
    - 매번 원래 URL을 확인
    - 사용
        + 점검 중 임시 페이지로 이동시킬 때
        + 로그인 후 임시로 다른 페이지로 리다이렉트할 때
        + A/B 테스트로 일부 사용자만 다른 페이지로 보낼 때
+ 주의사항
    - 301을 잘못 사용하면 브라우저가 오래된 정보를 캐싱하여 원래 URL으로 돌리고 싶어도 캐싱한 새 URL로 보내는 문제가 생길 수 있다!  

URL 리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블을 사용하는 것  

**URL 단축**
단축 URL이 www.tinyurl.com/{hashValue}와 같은 형태라고 하면 긴 URL을 해시 값으로 변환하는 함수를 찾는게 중요한 일이다  
해시 함수는 다음과 같은 요구사항을 만족해야 한다  

+ URL이 다르면 해시 값도 달라야한다
+ 변환된 해시 값은 원래 URL으로 복원가능해야한다

### 상세 설계
+ 데이터 모델
    - 가장 쉬운 방법은 해시 테이블이지만 초기 전략으로는 좋지만 실제 시스템에서는 메모리 문제때문에 곤란
    - `관계형 데이터베이스`가 좀 더 나은 방법
+ 해시 함수
    - 해시 값 길이  
        + hashValue는 [0-9, a-z, A-Z]의 문자로 구성, 사용할 수 있는 문자의 개수는 10 + 26 + 26으로 총 62개
        + 위에서 계산한 추정치에 따르면 시스템은 3650억 개의 URL을 생성해야 함
        + 62<sup>n</sup>>=3650억인 n의 최솟값을 찾아야 함 : n=7
    - 해시 후 충돌 해소
        + URL을 위에서 구한 hashValue만큼 줄여야한다
            - CRC32, MD5, SHA-1 등의 해시 함수가 있지만 모두 7보다 큰 결과를 낸다
    - base-62 변환
        + hashValue에서 사용할 수 있는 문자의 수가 62개이므로 62진법을 고려해볼 수 있다

|해시 후 충돌 해소 전략|base-62 변환|
|--|--|
|단축 URL의 길이가 고정됨|단축 URL의 길이가 가변적, ID 값이 커지면 같이 길어짐|
|유일성이 보장되는 ID 생성기가 필요 X|유일성 보장 ID 생성기가 필요|
|충돌이 가능해서 해소 전략이 필요|ID의 유일성이 보장된 후에야 적용가능한 전략이라 충돌 가능성 X|
|ID로부터 단축 URL을 계산하는 방식이 아니라 다음에 사용될 URL을 알아내는 것은 불가|ID가 1씩 증가하는 값이라고 가정하면 다음에 사용될 단축 URL이 무엇인지 확인 가능|

+ URL 단축기 상세 설계
    - 긴 URL을 입력받는다
    - 데이터베이스에 해당 URL이 있는지 검사
    - 데이터베이스에 존재하면 해당 URL을 반환
    - 데이터베이스에 없으면 새로운 URL이므로 ID를 생성한 후, 데이터베이스의 기본 키로 사용
    - 62 진법을 적용하여 ID를 단축 URL으로 변환
    - 단축 URL을 클라이언트에 전달
+ URL 리디렉션 상세 설계
    - 쓰기보다 읽기를 많이 하는 시스템이라 캐시해서 성능을 높이는 것이 좋다