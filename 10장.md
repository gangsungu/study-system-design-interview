## 알림 시스템 설계
알림 시스템은 최신 뉴스, 제품 업데이트, 이벤트, 선물 등 고객에서 중요할만한 정보를 비동기적으로 제공하는 기능이다

알림 시스템은 모바일 푸시 알림, SMS 메시지, 이메일 등으로 분류할 수 있다

### 읽기 전 간단하게 설계해보기
+ 알림 발송은 누락되면 안됨
    - 시간이 설정된 알림이면 무조건 해당 시간대에 발송되어야 함
+ 알림을 수신 거부 설정했으면 받지 않아야 함
+ 같은 알림이 여러번 발송되어도 안됨 (사용자가 피로감을 느끼고 알림 수신 거부 위험성 존재)
+ 푸시나 SMS, 이메일 서비스를 제공하는 서드 파티와 연동

### 놓친 부분
+ 연락처 정보 수집 절차 (당연히 사전에 제공하는 줄..)
+ 어떤 서비스는 특정 시장에서는 사용이 불가능할 수 있으므로 확장성을 고려

### 알림 시스템 작업 흐름
+ API를 호출하여 알림 서버로 알림을 전달
+ 알림 서버는 사용자 정보, 단말 토큰, 알림 설정과 같은 메타데이터를 캐시나 데이터베이스에서 가져온다
+ 알림 서버는 전송할 알림에 맞는 이벤트를 생성하여 큐에 넣는다
    - iOS 푸시 알림 이벤트는 iOS 푸시 알림 큐에 저장
+ 작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다
+ 작업 서버는 알림을 제3자 서비스로 이동시킨다
+ 제3자 서비스는 사용자 단말로 알림을 전송

### 안정성
알림 시스템이 분산 환경에서 돌아간다고 가정하면 안정성이 중요

+ 데이터 손실 방지
    - 어떤 상황에서도 알림이 소실되면 안된다 (매주 중요!, 알림 시스템의 본질)
    - 그래서 재시도 매커니즘을 추가해야 함
        + Dead Letter Queue
            - 계속 실패하는 알림은 별도의 큐에 보내서 수동 처리
        + Circuit Breaker
            - 제3자 서비스가 다운되면 일정 시간 요청을 멈춰서 전체 시스템 장애 방지
+ 알림 중복 전송 방지
    - 대부분의 경우, 알림은 한번만 발송되겠지만 분산 시스템의 특성상 100% 막기 어렵다
        + 멱등키를 추가하고 메모리에 저장하여 중복 방지 처리(Redis와 같은)
        + 같은 ID가 들어오면 무시
        + 최소 한 번(at-least-once)보다 정확히 한 번(exactly-once)에 가깝게 만들어야 한다

### 추가적인 고려사항
+ 알림 템플릿
    - 알림 메시지의 대부분은 형식이 비슷하다 따라서 알림 템플릿으로 처리할 수 있다
+ 알림 설정
    - 사용자가 알림의 수신 여부를 설정할 수 있어야 한다
+ 이벤트 추적
    - 알림 확인율, 클릭율, 실제 앱 사용으로 이루어지는 메트릭은 사용자 경험 분석에 매우 중요한 부분
    - 데이터 분석 서비스는 보통 이벤트 추적 기능도 제공한다
    - 알림 시스템을 만들면 데이터 분석 서비스도 통합하는게 일반적