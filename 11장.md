## 뉴스 피드 시스템 설계
뉴스 피드란 무엇인가?  

페이스북 도움말 페이지를 확인해보면 `뉴스 피드는 여러분의 홈페이지 중앙에 지속적으로 업데이트되는 스토리들로 사용자 상태 정보 업데이트, 사진, 비디오, 링크, 앱 활동 그리고 여러분이 페이스북에서 팔로우하는 사람들, 페이지 또는 그룹으로부터 나오는 좋아요 등을 포함한다`라고 설명하고 있다

### 읽기 전 간단하게 설계해보기
+ 뉴스 피드 서비스가 운영되는 플랫폼
    - 앱이냐 웹이냐, 둘 다 지원해야하면 API 형태로 개발되어야 한다
    - 사용자가 피드를 작성하면 저장하는 API (피드 발행) / 발행된 피드를 가져오는 API
+ 뉴스 피드가 업데이트되는 순서
    - 시간순, 좋아요순, 팔로우하는 친구 피드를 먼저 노출 등
    - 메모리에 캐싱하여 빠른 로딩 기대
+ 이미지나 비디오 업로드 가능
    - CDN으로 캐싱하여 빠른 로딩 기대
+ 알림 서비스
    - Redis pub/sub이나 Kafka 등

### 놓친 부분
+ 처리율 제한
    - 포스팅 작성의 처리율 제한
        + 스팸 방지와 시스템 보호가 목적
    - 피드 조회의 처리율 제한
        + 비용 절감과 크롤러 방지가 목적
    - 처리율 제한의 우선순위
        + 포스팅 작성 제한 (쓰기 비용이 제일 비쌈)
        + 팬아웃 총량 제한 (사용자 계정 보호)
        + 피드 조회 제한 (크롤러 방지)
        + IP 기반 제한 (DDoS 방어)

### 뉴스 피드 시스템 작업 흐름
+ 피드 발행
    - 사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 저장
    - 새 포스팅은 친구의 뉴스 피드에도 전송
+ 뉴스 피드 생성

### 포스팅 전송(팬아웃) 서비스
팬아웃 (fanout)은 새 포스팅을 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정  
팬아웃에는 두가지 모델이 있다

+ 쓰기 시점에 팬아웃 (fanout-on-write, push 모델)
    - 새로운 포스팅을 기록하는 시점에 뉴스 피드 갱신
    - 장점
        + 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송
        + 새 포스팅이 기록되는 순간 뉴스 피드가 갱신되므로 뉴스 피드를 읽는 시간이 짧아진다
    - 단점
        + 친구가 많은 사용자의 경우, 친구목록의 사용자 모두가 뉴스 피드를 갱신하는데 많은 시간이 소요될 수 있다 (hotkey)
        + 서비스를 자주 갱신하지 않는 사용자의 피드까지 갱신해야 하므로 리소스가 낭비된다
+ 읽기 시점에 팬아웃 (fanout-on-read, pull 모델)
    - 피드를 읽어야하는 시점에 뉴스 피드를 갱신한다 (사용자가 로딩하는 시점)
    - 장점
        + 비활성화된 사용자, 또는 서비스에 자주 로그인하지 않는 사용자의 경우, 유리
        + 데이터를 친구 목록 모두에게 푸시하는 작업이 필요없으므로 핫키 문제도 발생하지 않음
    - 단점
        + 뉴스 피드를 읽는데 많은 시간이 소요될 수 있다

뉴스 피드를 빠르게 가져오는 것은 언제나 중요하다  
따라서 푸시 모델을 기본으로 사용하고 친구나 팔로워가 많은 경우에만 풀 모델을 사용하여 시스템 과부하를 방지한다  

책에서는 푸시 모델과 풀 모델을 합친 하이브리드 모델을 언급했는데,  
실제로 구현해보면 다음과 같은 흐름이 적절할 것 같다  

+ 활성 사용자만 push, 비활성 사용자는 pull
    - 최근 N일간 로그인 이력으로 활성/비활성 판단


### 뉴스 피드 시스템 작업 흐름
+ 그래프 데이터베이스에서 친구 ID 목록을 조회
+ 사용자 정보 캐시에서 친구들의 정보를 조회
    - 수신거부를 활성화한 친구의 경우, 뉴스 피드 업데이트 무시
    - 새로 포스팅한 스토리가 일부 사용자에게만 공유되도록 설정된 경우도 동일
+ 친구 목록에서 새 스토리의 포스팅 ID를 메시지 큐에 저장
+ 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내 뉴스 피드 데이터를 뉴스 피드 캐시에 저장
    - 뉴스 피드 캐시의 크기는 제한을 두어야 한다
    - 모든 피드를 저장하기엔 서버의 부담이 크고 대부분의 사용자가 보려고 하는 것은 최신 스토리다

### 피드 읽기 흐름 상세 
+ 사용자가 뉴스 피드 읽기 요청을 보낸다
    - /v1/me/feed
+ 로드밸런서가 요청을 분배한다
+ 웹 서버는 피드를 읽기위해 뉴스 피드 서비스를 호출
+ 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록을 읽는다
+ 뉴스 피드에 표시할 정보를 조회하여 완전한 뉴스 피드를 만든다
+ 생성된 뉴스 피드를 JSON 형태로 클라이언트에게 전달한다

### 캐시 구조
뉴스 피드의 빠른 로딩을 위해 캐시를 사용한다

+ 뉴스 피드
    - 뉴스 피드의 ID를 보관한다
+ 콘텐츠
    - 포스팅 데이터를 보관, 인기 데이터는 따로 보관
+ 소셜 그래프
    - 사용자 간의 관계 정보를 저장
+ 행동
    - 포스팅에 대한 사용자의 행위정보를 저장
    - 좋아요, 답글 등
+ 횟수
    - 좋아요 횟수, 응답 수, 팔로워 수 등을 저장

### 추가적인 고려사항
+ 데이터베이스 규모 확장
    - 수직적 규모 확장 vs 수평적 규모 확장
    - SQL vs NoSQL
    - 마스터-슬레이브 다중화
    - 레플리카에 대한 읽기 연산
    - 일관성 모델
    - 데이터베이스 샤딩
+ 웹 계층을 무상태로 운영하기
+ 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기